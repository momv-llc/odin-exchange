generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CurrencyType {
  CRYPTO
  FIAT
}

enum OrderStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
  EXPIRED
  CANCELLED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  OPERATOR
}

model Currency {
  id        String       @id @default(uuid()) @db.Uuid
  code      String       @unique @db.VarChar(10)
  name      String       @db.VarChar(100)
  type      CurrencyType
  isActive  Boolean      @default(true) @map("is_active")
  minAmount Decimal      @map("min_amount") @db.Decimal(20, 8)
  maxAmount Decimal      @map("max_amount") @db.Decimal(20, 8)
  decimals  Int          @default(8)
  network   String?      @db.VarChar(50)
  iconUrl   String?      @map("icon_url")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  ordersFrom Order[]        @relation("OrderFrom")
  ordersTo   Order[]        @relation("OrderTo")
  ratesFrom  ExchangeRate[] @relation("RateFrom")
  ratesTo    ExchangeRate[] @relation("RateTo")

  @@map("currencies")
}

model ExchangeRate {
  id             String   @id @default(uuid()) @db.Uuid
  fromCurrencyId String   @map("from_currency_id") @db.Uuid
  toCurrencyId   String   @map("to_currency_id") @db.Uuid
  rate           Decimal  @db.Decimal(20, 8)
  spreadPercent  Decimal  @default(0.5) @map("spread_percent") @db.Decimal(5, 2)
  effectiveRate  Decimal  @map("effective_rate") @db.Decimal(20, 8)
  source         String   @default("binance") @db.VarChar(50)
  fetchedAt      DateTime @map("fetched_at")
  createdAt      DateTime @default(now()) @map("created_at")

  fromCurrency Currency @relation("RateFrom", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("RateTo", fields: [toCurrencyId], references: [id])
  orders       Order[]

  @@unique([fromCurrencyId, toCurrencyId])
  @@map("exchange_rates")
}

model Order {
  id             String      @id @default(uuid()) @db.Uuid
  code           String      @unique @db.VarChar(20)
  fromCurrencyId String      @map("from_currency_id") @db.Uuid
  toCurrencyId   String      @map("to_currency_id") @db.Uuid
  fromAmount     Decimal     @map("from_amount") @db.Decimal(20, 8)
  toAmount       Decimal     @map("to_amount") @db.Decimal(20, 8)
  exchangeRateId String      @map("exchange_rate_id") @db.Uuid
  lockedRate     Decimal     @map("locked_rate") @db.Decimal(20, 8)
  status         OrderStatus @default(PENDING)
  clientEmail    String      @map("client_email") @db.VarChar(255)
  clientPhone    String?     @map("client_phone") @db.VarChar(50)
  clientWallet   String      @map("client_wallet") @db.VarChar(255)
  adminNotes     String?     @map("admin_notes") @db.Text
  processedBy    String?     @map("processed_by") @db.Uuid
  expiresAt      DateTime    @map("expires_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  fromCurrency     Currency             @relation("OrderFrom", fields: [fromCurrencyId], references: [id])
  toCurrency       Currency             @relation("OrderTo", fields: [toCurrencyId], references: [id])
  exchangeRate     ExchangeRate         @relation(fields: [exchangeRateId], references: [id])
  processedByAdmin Admin?               @relation(fields: [processedBy], references: [id])
  statusHistory    OrderStatusHistory[]

  @@index([status, createdAt])
  @@index([clientEmail])
  @@index([expiresAt])
  @@map("orders")
}

model OrderStatusHistory {
  id         String   @id @default(uuid()) @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  fromStatus String   @map("from_status") @db.VarChar(50)
  toStatus   String   @map("to_status") @db.VarChar(50)
  changedBy  String?  @map("changed_by") @db.Uuid
  reason     String?  @db.Text
  ipAddress  String?  @map("ip_address") @db.Inet
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("order_status_history")
}

model Admin {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique @db.VarChar(255)
  passwordHash   String    @map("password_hash")
  role           AdminRole @default(OPERATOR)
  totpSecret     String?   @map("totp_secret")
  is2faEnabled   Boolean   @default(false) @map("is_2fa_enabled")
  isActive       Boolean   @default(true) @map("is_active")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  sessions  AdminSession[]
  auditLogs AuditLog[]
  orders    Order[]

  @@map("admins")
}

model AdminSession {
  id          String   @id @default(uuid()) @db.Uuid
  adminId     String   @map("admin_id") @db.Uuid
  tokenHash   String   @map("token_hash")
  ipAddress   String   @map("ip_address") @db.Inet
  userAgent   String   @map("user_agent") @db.Text
  fingerprint String?
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  adminId    String?  @map("admin_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Uuid
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent") @db.Text
  requestId  String?  @map("request_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  admin Admin? @relation(fields: [adminId], references: [id])

  @@index([entityType, entityId])
  @@index([adminId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       Json
  description String?  @db.Text
  updatedBy   String?  @map("updated_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

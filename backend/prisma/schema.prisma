generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // Remove or comment out this line if not using connection pooling:
  // directUrl = env("DIRECT_URL")
}

enum CurrencyType {
  CRYPTO
  FIAT
}

enum OrderStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
  EXPIRED
  CANCELLED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  OPERATOR
}

model Currency {
  id        String       @id @default(uuid()) @db.Uuid
  code      String       @unique @db.VarChar(10)
  name      String       @db.VarChar(100)
  type      CurrencyType
  isActive  Boolean      @default(true) @map("is_active")
  minAmount Decimal      @map("min_amount") @db.Decimal(20, 8)
  maxAmount Decimal      @map("max_amount") @db.Decimal(20, 8)
  decimals  Int          @default(8)
  network   String?      @db.VarChar(50)
  iconUrl   String?      @map("icon_url")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  ordersFrom Order[]        @relation("OrderFrom")
  ordersTo   Order[]        @relation("OrderTo")
  ratesFrom  ExchangeRate[] @relation("RateFrom")
  ratesTo    ExchangeRate[] @relation("RateTo")

  @@map("currencies")
}

model ExchangeRate {
  id             String   @id @default(uuid()) @db.Uuid
  fromCurrencyId String   @map("from_currency_id") @db.Uuid
  toCurrencyId   String   @map("to_currency_id") @db.Uuid
  rate           Decimal  @db.Decimal(20, 8)
  spreadPercent  Decimal  @default(0.5) @map("spread_percent") @db.Decimal(5, 2)
  effectiveRate  Decimal  @map("effective_rate") @db.Decimal(20, 8)
  source         String   @default("binance") @db.VarChar(50)
  fetchedAt      DateTime @map("fetched_at")
  createdAt      DateTime @default(now()) @map("created_at")

  fromCurrency Currency @relation("RateFrom", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("RateTo", fields: [toCurrencyId], references: [id])
  orders       Order[]

  @@unique([fromCurrencyId, toCurrencyId])
  @@map("exchange_rates")
}

model Order {
  id             String      @id @default(uuid()) @db.Uuid
  code           String      @unique @db.VarChar(20)
  userId         String?     @map("user_id") @db.Uuid
  fromCurrencyId String      @map("from_currency_id") @db.Uuid
  toCurrencyId   String      @map("to_currency_id") @db.Uuid
  fromAmount     Decimal     @map("from_amount") @db.Decimal(20, 8)
  toAmount       Decimal     @map("to_amount") @db.Decimal(20, 8)
  exchangeRateId String      @map("exchange_rate_id") @db.Uuid
  lockedRate     Decimal     @map("locked_rate") @db.Decimal(20, 8)
  status         OrderStatus @default(PENDING)
  clientEmail    String      @map("client_email") @db.VarChar(255)
  clientPhone    String?     @map("client_phone") @db.VarChar(50)
  clientWallet   String      @map("client_wallet") @db.VarChar(255)
  adminNotes     String?     @map("admin_notes") @db.Text
  processedBy    String?     @map("processed_by") @db.Uuid
  expiresAt      DateTime    @map("expires_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  user             User?                @relation("UserOrders", fields: [userId], references: [id])
  fromCurrency     Currency             @relation("OrderFrom", fields: [fromCurrencyId], references: [id])
  toCurrency       Currency             @relation("OrderTo", fields: [toCurrencyId], references: [id])
  exchangeRate     ExchangeRate         @relation(fields: [exchangeRateId], references: [id])
  processedByAdmin Admin?               @relation(fields: [processedBy], references: [id])
  statusHistory    OrderStatusHistory[]

  @@index([status, createdAt])
  @@index([clientEmail])
  @@index([expiresAt])
  @@index([userId])
  @@map("orders")
}

model OrderStatusHistory {
  id         String   @id @default(uuid()) @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  fromStatus String   @map("from_status") @db.VarChar(50)
  toStatus   String   @map("to_status") @db.VarChar(50)
  changedBy  String?  @map("changed_by") @db.Uuid
  reason     String?  @db.Text
  ipAddress  String?  @map("ip_address") @db.Inet
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("order_status_history")
}

model Admin {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique @db.VarChar(255)
  passwordHash   String    @map("password_hash")
  role           AdminRole @default(OPERATOR)
  totpSecret     String?   @map("totp_secret")
  is2faEnabled   Boolean   @default(false) @map("is_2fa_enabled")
  isActive       Boolean   @default(true) @map("is_active")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  sessions         AdminSession[]
  auditLogs        AuditLog[]
  orders           Order[]
  moderatedReviews Review[]
  createdPromos    Promo[]        @relation("PromoCreator")

  @@map("admins")
}

model AdminSession {
  id          String   @id @default(uuid()) @db.Uuid
  adminId     String   @map("admin_id") @db.Uuid
  tokenHash   String   @map("token_hash")
  ipAddress   String   @map("ip_address") @db.Inet
  userAgent   String   @map("user_agent") @db.Text
  fingerprint String?
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  adminId    String?  @map("admin_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Uuid
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent") @db.Text
  requestId  String?  @map("request_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  admin Admin? @relation(fields: [adminId], references: [id])

  @@index([entityType, entityId])
  @@index([adminId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       Json
  description String?  @db.Text
  updatedBy   String?  @map("updated_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ==================== USER AUTH ====================

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

model User {
  id             String     @id @default(uuid()) @db.Uuid
  email          String     @unique @db.VarChar(255)
  passwordHash   String     @map("password_hash")
  firstName      String?    @map("first_name") @db.VarChar(100)
  lastName       String?    @map("last_name") @db.VarChar(100)
  phone          String?    @db.VarChar(50)
  avatarUrl      String?    @map("avatar_url")
  status         UserStatus @default(ACTIVE)
  isVerified     Boolean    @default(false) @map("is_verified")
  verifyToken    String?    @map("verify_token")
  resetToken     String?    @map("reset_token")
  resetTokenExp  DateTime?  @map("reset_token_exp")
  telegramId     String?    @map("telegram_id") @db.VarChar(100)
  whatsappPhone  String?    @map("whatsapp_phone") @db.VarChar(50)
  preferredLang  String     @default("en") @map("preferred_lang") @db.VarChar(5)
  referralCode   String?    @unique @map("referral_code") @db.VarChar(20)
  referredBy     String?    @map("referred_by") @db.Uuid
  kycLevel       KycLevel   @default(NONE) @map("kyc_level")
  lastLoginAt    DateTime?  @map("last_login_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  sessions          UserSession[]
  reviews           Review[]
  orders            Order[]            @relation("UserOrders")
  payments          Payment[]
  kyc               KycVerification?
  referralsGiven    Referral[]         @relation("Referrer")
  referralReceived  Referral?          @relation("Referred")
  referralRewards   ReferralReward[]
  analytics         UserAnalytics?
  pushSubscriptions PushSubscription[]

  @@index([email])
  @@index([telegramId])
  @@index([referralCode])
  @@map("users")
}

model UserSession {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  tokenHash   String   @map("token_hash")
  ipAddress   String   @map("ip_address") @db.Inet
  userAgent   String   @map("user_agent") @db.Text
  deviceInfo  String?  @map("device_info")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("user_sessions")
}

// ==================== REVIEWS ====================

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

model Review {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String?      @map("user_id") @db.Uuid
  orderId     String?      @map("order_id") @db.Uuid
  authorName  String       @map("author_name") @db.VarChar(100)
  authorEmail String?      @map("author_email") @db.VarChar(255)
  rating      Int          @db.SmallInt
  title       String?      @db.VarChar(200)
  content     String       @db.Text
  status      ReviewStatus @default(PENDING)
  moderatedBy String?      @map("moderated_by") @db.Uuid
  moderatedAt DateTime?    @map("moderated_at")
  adminNotes  String?      @map("admin_notes") @db.Text
  ipAddress   String?      @map("ip_address") @db.Inet
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user      User?  @relation(fields: [userId], references: [id])
  moderator Admin? @relation(fields: [moderatedBy], references: [id])

  @@index([status, createdAt])
  @@index([rating])
  @@map("reviews")
}

// ==================== PROMO ====================

enum PromoType {
  DISCOUNT_PERCENT
  DISCOUNT_FIXED
  BONUS
}

model Promo {
  id            String    @id @default(uuid()) @db.Uuid
  code          String    @unique @db.VarChar(50)
  type          PromoType
  value         Decimal   @db.Decimal(10, 2)
  description   String?   @db.Text
  minAmount     Decimal?  @map("min_amount") @db.Decimal(20, 8)
  maxUses       Int?      @map("max_uses")
  usedCount     Int       @default(0) @map("used_count")
  validFrom     DateTime  @map("valid_from")
  validUntil    DateTime  @map("valid_until")
  isActive      Boolean   @default(true) @map("is_active")
  createdBy     String?   @map("created_by") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  creator Admin? @relation("PromoCreator", fields: [createdBy], references: [id])
  usages  PromoUsage[]

  @@index([code])
  @@index([validFrom, validUntil])
  @@map("promos")
}

model PromoUsage {
  id        String   @id @default(uuid()) @db.Uuid
  promoId   String   @map("promo_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  orderId   String?  @map("order_id") @db.Uuid
  discount  Decimal  @db.Decimal(20, 8)
  usedAt    DateTime @default(now()) @map("used_at")

  promo Promo @relation(fields: [promoId], references: [id])

  @@index([promoId])
  @@map("promo_usages")
}

// ==================== NOTIFICATIONS ====================

enum NotificationChannel {
  EMAIL
  TELEGRAM
  WHATSAPP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model NotificationTemplate {
  id        String              @id @default(uuid()) @db.Uuid
  name      String              @unique @db.VarChar(100)
  channel   NotificationChannel
  subject   String?             @db.VarChar(255)
  template  String              @db.Text
  variables Json?
  isActive  Boolean             @default(true) @map("is_active")
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  @@map("notification_templates")
}

model NotificationLog {
  id          String              @id @default(uuid()) @db.Uuid
  userId      String?             @map("user_id") @db.Uuid
  channel     NotificationChannel
  recipient   String              @db.VarChar(255)
  subject     String?             @db.VarChar(255)
  content     String              @db.Text
  status      NotificationStatus  @default(PENDING)
  errorMsg    String?             @map("error_msg") @db.Text
  sentAt      DateTime?           @map("sent_at")
  readAt      DateTime?           @map("read_at")
  metadata    Json?
  createdAt   DateTime            @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([channel, status])
  @@map("notification_logs")
}

// ==================== LOCATIONS ====================

model Country {
  id         String   @id @default(uuid()) @db.Uuid
  code       String   @unique @db.VarChar(3)
  nameEn     String   @map("name_en") @db.VarChar(100)
  nameRu     String?  @map("name_ru") @db.VarChar(100)
  nameUa     String?  @map("name_ua") @db.VarChar(100)
  nameDe     String?  @map("name_de") @db.VarChar(100)
  flagEmoji  String?  @map("flag_emoji") @db.VarChar(10)
  phoneCode  String?  @map("phone_code") @db.VarChar(10)
  currency   String?  @db.VarChar(10)
  timezone   String?  @db.VarChar(50)
  sortOrder  Int      @default(0) @map("sort_order")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  cities         City[]
  paymentMethods PaymentMethod[]

  @@index([isActive, sortOrder])
  @@map("countries")
}

model City {
  id          String   @id @default(uuid()) @db.Uuid
  countryId   String   @map("country_id") @db.Uuid
  nameEn      String   @map("name_en") @db.VarChar(100)
  nameRu      String?  @map("name_ru") @db.VarChar(100)
  nameUa      String?  @map("name_ua") @db.VarChar(100)
  nameDe      String?  @map("name_de") @db.VarChar(100)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  population  Int?
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  isFeatured  Boolean  @default(false) @map("is_featured")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  country        Country         @relation(fields: [countryId], references: [id])
  paymentMethods PaymentMethod[]
  transfers      MoneyTransfer[]

  @@index([countryId, isActive])
  @@index([isFeatured])
  @@map("cities")
}

// ==================== PAYMENT METHODS ====================

enum PaymentMethodType {
  CASH
  CARD
  BANK_TRANSFER
  CRYPTO_WALLET
  MOBILE_PAYMENT
}

model PaymentMethod {
  id             String            @id @default(uuid()) @db.Uuid
  type           PaymentMethodType
  nameEn         String            @map("name_en") @db.VarChar(100)
  nameRu         String?           @map("name_ru") @db.VarChar(100)
  nameUa         String?           @map("name_ua") @db.VarChar(100)
  nameDe         String?           @map("name_de") @db.VarChar(100)
  descriptionEn  String?           @map("description_en") @db.Text
  descriptionRu  String?           @map("description_ru") @db.Text
  icon           String?           @db.VarChar(100)
  countryId      String?           @map("country_id") @db.Uuid
  cityId         String?           @map("city_id") @db.Uuid
  minAmount      Decimal?          @map("min_amount") @db.Decimal(20, 2)
  maxAmount      Decimal?          @map("max_amount") @db.Decimal(20, 2)
  feePercent     Decimal           @default(0) @map("fee_percent") @db.Decimal(5, 2)
  feeFixed       Decimal           @default(0) @map("fee_fixed") @db.Decimal(20, 2)
  processingTime String?           @map("processing_time") @db.VarChar(100)
  instructions   String?           @db.Text
  sortOrder      Int               @default(0) @map("sort_order")
  isActive       Boolean           @default(true) @map("is_active")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  country   Country? @relation(fields: [countryId], references: [id])
  city      City?    @relation(fields: [cityId], references: [id])

  @@index([type, isActive])
  @@index([countryId])
  @@index([cityId])
  @@map("payment_methods")
}

// ==================== MONEY TRANSFERS ====================

enum TransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

model MoneyTransfer {
  id              String         @id @default(uuid()) @db.Uuid
  code            String         @unique @db.VarChar(20)
  userId          String?        @map("user_id") @db.Uuid
  senderName      String         @map("sender_name") @db.VarChar(200)
  senderPhone     String         @map("sender_phone") @db.VarChar(50)
  senderEmail     String?        @map("sender_email") @db.VarChar(255)
  recipientName   String         @map("recipient_name") @db.VarChar(200)
  recipientPhone  String         @map("recipient_phone") @db.VarChar(50)
  recipientCityId String         @map("recipient_city_id") @db.Uuid
  amount          Decimal        @db.Decimal(20, 2)
  currency        String         @db.VarChar(10)
  fee             Decimal        @db.Decimal(20, 2)
  totalAmount     Decimal        @map("total_amount") @db.Decimal(20, 2)
  status          TransferStatus @default(PENDING)
  notes           String?        @db.Text
  adminNotes      String?        @map("admin_notes") @db.Text
  processedBy     String?        @map("processed_by") @db.Uuid
  completedAt     DateTime?      @map("completed_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  recipientCity City @relation(fields: [recipientCityId], references: [id])

  @@index([status, createdAt])
  @@index([senderPhone])
  @@index([recipientPhone])
  @@map("money_transfers")
}

// ==================== EXCHANGE PAIRS (for admin) ====================

model ExchangePair {
  id            String   @id @default(uuid()) @db.Uuid
  fromCurrency  String   @map("from_currency") @db.VarChar(10)
  toCurrency    String   @map("to_currency") @db.VarChar(10)
  spreadBuy     Decimal  @map("spread_buy") @db.Decimal(5, 2)
  spreadSell    Decimal  @map("spread_sell") @db.Decimal(5, 2)
  minAmount     Decimal  @map("min_amount") @db.Decimal(20, 8)
  maxAmount     Decimal  @map("max_amount") @db.Decimal(20, 8)
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([fromCurrency, toCurrency])
  @@index([isActive])
  @@map("exchange_pairs")
}

// ==================== REAL-TIME EXCHANGE RATES ====================

enum RateSource {
  COINGECKO
  BINANCE
  FIXER
  OPENEXCHANGERATES
  MANUAL
}

model LiveExchangeRate {
  id            String     @id @default(uuid()) @db.Uuid
  baseCurrency  String     @map("base_currency") @db.VarChar(10)
  quoteCurrency String     @map("quote_currency") @db.VarChar(10)
  rate          Decimal    @db.Decimal(20, 8)
  source        RateSource
  change24h     Decimal?   @map("change_24h") @db.Decimal(10, 4)
  high24h       Decimal?   @map("high_24h") @db.Decimal(20, 8)
  low24h        Decimal?   @map("low_24h") @db.Decimal(20, 8)
  volume24h     Decimal?   @map("volume_24h") @db.Decimal(30, 8)
  marketCap     Decimal?   @map("market_cap") @db.Decimal(30, 2)
  lastUpdated   DateTime   @map("last_updated")
  createdAt     DateTime   @default(now()) @map("created_at")

  @@unique([baseCurrency, quoteCurrency, source])
  @@index([baseCurrency])
  @@index([lastUpdated])
  @@map("live_exchange_rates")
}

model RateHistory {
  id            String   @id @default(uuid()) @db.Uuid
  baseCurrency  String   @map("base_currency") @db.VarChar(10)
  quoteCurrency String   @map("quote_currency") @db.VarChar(10)
  rate          Decimal  @db.Decimal(20, 8)
  open          Decimal? @db.Decimal(20, 8)
  high          Decimal? @db.Decimal(20, 8)
  low           Decimal? @db.Decimal(20, 8)
  close         Decimal? @db.Decimal(20, 8)
  volume        Decimal? @db.Decimal(30, 8)
  timestamp     DateTime
  interval      String   @db.VarChar(10) // 1m, 5m, 1h, 1d
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([baseCurrency, quoteCurrency, timestamp, interval])
  @@index([baseCurrency, quoteCurrency, timestamp])
  @@map("rate_history")
}

// ==================== PAYMENT GATEWAYS ====================

enum PaymentGateway {
  STRIPE
  PAYPAL
  COINBASE
  BINANCE_PAY
  CRYPTO_DIRECT
  MANUAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
  EXPIRED
}

model Payment {
  id               String         @id @default(uuid()) @db.Uuid
  code             String         @unique @db.VarChar(30)
  userId           String?        @map("user_id") @db.Uuid
  orderId          String?        @map("order_id") @db.Uuid
  gateway          PaymentGateway
  externalId       String?        @map("external_id") @db.VarChar(255)
  amount           Decimal        @db.Decimal(20, 8)
  currency         String         @db.VarChar(10)
  feeAmount        Decimal        @default(0) @map("fee_amount") @db.Decimal(20, 8)
  netAmount        Decimal        @map("net_amount") @db.Decimal(20, 8)
  status           PaymentStatus  @default(PENDING)
  paymentMethod    String?        @map("payment_method") @db.VarChar(50)
  customerEmail    String?        @map("customer_email") @db.VarChar(255)
  billingAddress   Json?          @map("billing_address")
  metadata         Json?
  webhookData      Json?          @map("webhook_data")
  errorMessage     String?        @map("error_message") @db.Text
  paidAt           DateTime?      @map("paid_at")
  expiresAt        DateTime?      @map("expires_at")
  refundedAt       DateTime?      @map("refunded_at")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  user    User?    @relation(fields: [userId], references: [id])
  refunds Refund[]

  @@index([userId])
  @@index([orderId])
  @@index([externalId])
  @@index([status, createdAt])
  @@index([gateway, status])
  @@map("payments")
}

model Refund {
  id            String        @id @default(uuid()) @db.Uuid
  paymentId     String        @map("payment_id") @db.Uuid
  externalId    String?       @map("external_id") @db.VarChar(255)
  amount        Decimal       @db.Decimal(20, 8)
  reason        String?       @db.Text
  status        PaymentStatus @default(PENDING)
  processedBy   String?       @map("processed_by") @db.Uuid
  processedAt   DateTime?     @map("processed_at")
  createdAt     DateTime      @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
  @@map("refunds")
}

model CryptoWallet {
  id           String   @id @default(uuid()) @db.Uuid
  currency     String   @db.VarChar(10)
  network      String   @db.VarChar(50)
  address      String   @unique @db.VarChar(255)
  label        String?  @db.VarChar(100)
  isHot        Boolean  @default(true) @map("is_hot")
  balance      Decimal  @default(0) @db.Decimal(30, 8)
  lastSyncedAt DateTime? @map("last_synced_at")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  transactions CryptoTransaction[]

  @@index([currency, network])
  @@map("crypto_wallets")
}

enum CryptoTxType {
  DEPOSIT
  WITHDRAWAL
  INTERNAL
}

enum CryptoTxStatus {
  PENDING
  CONFIRMING
  CONFIRMED
  FAILED
}

model CryptoTransaction {
  id            String          @id @default(uuid()) @db.Uuid
  walletId      String          @map("wallet_id") @db.Uuid
  userId        String?         @map("user_id") @db.Uuid
  txHash        String?         @map("tx_hash") @db.VarChar(255)
  type          CryptoTxType
  amount        Decimal         @db.Decimal(30, 8)
  fee           Decimal         @default(0) @db.Decimal(30, 8)
  fromAddress   String?         @map("from_address") @db.VarChar(255)
  toAddress     String          @map("to_address") @db.VarChar(255)
  confirmations Int             @default(0)
  requiredConfs Int             @default(3) @map("required_confs")
  status        CryptoTxStatus  @default(PENDING)
  blockNumber   BigInt?         @map("block_number")
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  wallet CryptoWallet @relation(fields: [walletId], references: [id])

  @@index([txHash])
  @@index([userId])
  @@index([status])
  @@map("crypto_transactions")
}

// ==================== KYC VERIFICATION ====================

enum KycStatus {
  NOT_STARTED
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum KycLevel {
  NONE
  BASIC
  INTERMEDIATE
  ADVANCED
}

enum DocumentType {
  PASSPORT
  ID_CARD
  DRIVERS_LICENSE
  RESIDENCE_PERMIT
  UTILITY_BILL
  BANK_STATEMENT
  SELFIE
}

model KycVerification {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @unique @map("user_id") @db.Uuid
  level            KycLevel  @default(NONE)
  status           KycStatus @default(NOT_STARTED)
  firstName        String?   @map("first_name") @db.VarChar(100)
  lastName         String?   @map("last_name") @db.VarChar(100)
  middleName       String?   @map("middle_name") @db.VarChar(100)
  dateOfBirth      DateTime? @map("date_of_birth") @db.Date
  nationality      String?   @db.VarChar(3)
  countryOfResidence String? @map("country_of_residence") @db.VarChar(3)
  address          String?   @db.Text
  city             String?   @db.VarChar(100)
  postalCode       String?   @map("postal_code") @db.VarChar(20)
  phoneVerified    Boolean   @default(false) @map("phone_verified")
  emailVerified    Boolean   @default(false) @map("email_verified")
  documentVerified Boolean   @default(false) @map("document_verified")
  addressVerified  Boolean   @default(false) @map("address_verified")
  selfieVerified   Boolean   @default(false) @map("selfie_verified")
  riskScore        Int?      @map("risk_score")
  amlCheckPassed   Boolean?  @map("aml_check_passed")
  sanctionsCheck   Boolean?  @map("sanctions_check")
  pepCheck         Boolean?  @map("pep_check")
  externalId       String?   @map("external_id") @db.VarChar(255)
  provider         String?   @db.VarChar(50)
  reviewedBy       String?   @map("reviewed_by") @db.Uuid
  reviewedAt       DateTime? @map("reviewed_at")
  rejectionReason  String?   @map("rejection_reason") @db.Text
  expiresAt        DateTime? @map("expires_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user      User          @relation(fields: [userId], references: [id])
  documents KycDocument[]

  @@index([status])
  @@index([level])
  @@map("kyc_verifications")
}

model KycDocument {
  id             String       @id @default(uuid()) @db.Uuid
  kycId          String       @map("kyc_id") @db.Uuid
  type           DocumentType
  fileName       String       @map("file_name") @db.VarChar(255)
  fileUrl        String       @map("file_url") @db.Text
  fileSize       Int          @map("file_size")
  mimeType       String       @map("mime_type") @db.VarChar(100)
  documentNumber String?      @map("document_number") @db.VarChar(100)
  issuedBy       String?      @map("issued_by") @db.VarChar(100)
  issuedDate     DateTime?    @map("issued_date") @db.Date
  expiryDate     DateTime?    @map("expiry_date") @db.Date
  isVerified     Boolean      @default(false) @map("is_verified")
  verificationData Json?      @map("verification_data")
  rejectionReason String?     @map("rejection_reason") @db.Text
  uploadedAt     DateTime     @default(now()) @map("uploaded_at")

  kyc KycVerification @relation(fields: [kycId], references: [id], onDelete: Cascade)

  @@index([kycId, type])
  @@map("kyc_documents")
}

// ==================== REFERRAL SYSTEM ====================

model Referral {
  id              String    @id @default(uuid()) @db.Uuid
  referrerId      String    @map("referrer_id") @db.Uuid
  referredId      String    @unique @map("referred_id") @db.Uuid
  code            String    @db.VarChar(20)
  status          String    @default("pending") @db.VarChar(20)
  rewardPaid      Boolean   @default(false) @map("reward_paid")
  referrerReward  Decimal?  @map("referrer_reward") @db.Decimal(20, 8)
  referredBonus   Decimal?  @map("referred_bonus") @db.Decimal(20, 8)
  conversionDate  DateTime? @map("conversion_date")
  createdAt       DateTime  @default(now()) @map("created_at")

  referrer User @relation("Referrer", fields: [referrerId], references: [id])
  referred User @relation("Referred", fields: [referredId], references: [id])

  @@index([referrerId])
  @@index([code])
  @@map("referrals")
}

model ReferralReward {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  referralId    String   @map("referral_id") @db.Uuid
  orderId       String?  @map("order_id") @db.Uuid
  rewardType    String   @map("reward_type") @db.VarChar(50)
  amount        Decimal  @db.Decimal(20, 8)
  currency      String   @db.VarChar(10)
  percentage    Decimal? @db.Decimal(5, 2)
  status        String   @default("pending") @db.VarChar(20)
  paidAt        DateTime? @map("paid_at")
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([referralId])
  @@map("referral_rewards")
}

model ReferralSettings {
  id                     String   @id @default(uuid()) @db.Uuid
  tierName               String   @map("tier_name") @db.VarChar(50)
  minReferrals           Int      @default(0) @map("min_referrals")
  referrerRewardPercent  Decimal  @map("referrer_reward_percent") @db.Decimal(5, 2)
  referredBonusPercent   Decimal  @map("referred_bonus_percent") @db.Decimal(5, 2)
  lifetimeCommission     Boolean  @default(false) @map("lifetime_commission")
  commissionDurationDays Int?     @map("commission_duration_days")
  isActive               Boolean  @default(true) @map("is_active")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("referral_settings")
}

// ==================== ANALYTICS ====================

model AnalyticsEvent {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  sessionId   String?  @map("session_id") @db.VarChar(100)
  eventType   String   @map("event_type") @db.VarChar(50)
  eventName   String   @map("event_name") @db.VarChar(100)
  eventData   Json?    @map("event_data")
  page        String?  @db.VarChar(255)
  referrer    String?  @db.VarChar(255)
  utmSource   String?  @map("utm_source") @db.VarChar(100)
  utmMedium   String?  @map("utm_medium") @db.VarChar(100)
  utmCampaign String?  @map("utm_campaign") @db.VarChar(100)
  deviceType  String?  @map("device_type") @db.VarChar(20)
  browser     String?  @db.VarChar(50)
  os          String?  @db.VarChar(50)
  country     String?  @db.VarChar(3)
  city        String?  @db.VarChar(100)
  ipAddress   String?  @map("ip_address") @db.Inet
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([eventType, eventName])
  @@index([sessionId])
  @@index([createdAt])
  @@map("analytics_events")
}

model DailyStats {
  id                String   @id @default(uuid()) @db.Uuid
  date              DateTime @db.Date
  totalOrders       Int      @default(0) @map("total_orders")
  completedOrders   Int      @default(0) @map("completed_orders")
  cancelledOrders   Int      @default(0) @map("cancelled_orders")
  totalVolume       Decimal  @default(0) @map("total_volume") @db.Decimal(30, 8)
  totalFees         Decimal  @default(0) @map("total_fees") @db.Decimal(30, 8)
  newUsers          Int      @default(0) @map("new_users")
  activeUsers       Int      @default(0) @map("active_users")
  newReferrals      Int      @default(0) @map("new_referrals")
  referralPayouts   Decimal  @default(0) @map("referral_payouts") @db.Decimal(30, 8)
  uniqueVisitors    Int      @default(0) @map("unique_visitors")
  pageViews         Int      @default(0) @map("page_views")
  avgOrderValue     Decimal  @default(0) @map("avg_order_value") @db.Decimal(20, 8)
  conversionRate    Decimal  @default(0) @map("conversion_rate") @db.Decimal(5, 4)
  topCurrencyPair   String?  @map("top_currency_pair") @db.VarChar(20)
  topCountry        String?  @map("top_country") @db.VarChar(3)
  createdAt         DateTime @default(now()) @map("created_at")

  @@unique([date])
  @@index([date])
  @@map("daily_stats")
}

model UserAnalytics {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  totalOrders        Int       @default(0) @map("total_orders")
  completedOrders    Int       @default(0) @map("completed_orders")
  totalVolume        Decimal   @default(0) @map("total_volume") @db.Decimal(30, 8)
  totalFeesPaid      Decimal   @default(0) @map("total_fees_paid") @db.Decimal(30, 8)
  referralEarnings   Decimal   @default(0) @map("referral_earnings") @db.Decimal(30, 8)
  referralCount      Int       @default(0) @map("referral_count")
  avgOrderValue      Decimal   @default(0) @map("avg_order_value") @db.Decimal(20, 8)
  lastOrderAt        DateTime? @map("last_order_at")
  firstOrderAt       DateTime? @map("first_order_at")
  favoritePair       String?   @map("favorite_pair") @db.VarChar(20)
  lifetimeValue      Decimal   @default(0) @map("lifetime_value") @db.Decimal(30, 8)
  riskScore          Int       @default(0) @map("risk_score")
  segment            String?   @db.VarChar(50)
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("user_analytics")
}

// ==================== PUSH NOTIFICATIONS ====================

model PushSubscription {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  endpoint     String   @unique @db.Text
  p256dh       String   @db.Text
  auth         String   @db.VarChar(255)
  userAgent    String?  @map("user_agent") @db.Text
  deviceType   String?  @map("device_type") @db.VarChar(20)
  isActive     Boolean  @default(true) @map("is_active")
  lastUsedAt   DateTime? @map("last_used_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model PushNotification {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  title       String   @db.VarChar(255)
  body        String   @db.Text
  icon        String?  @db.VarChar(255)
  image       String?  @db.VarChar(255)
  url         String?  @db.VarChar(255)
  data        Json?
  sentCount   Int      @default(0) @map("sent_count")
  failedCount Int      @default(0) @map("failed_count")
  clickedCount Int     @default(0) @map("clicked_count")
  scheduledAt DateTime? @map("scheduled_at")
  sentAt      DateTime? @map("sent_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([scheduledAt])
  @@map("push_notifications")
}

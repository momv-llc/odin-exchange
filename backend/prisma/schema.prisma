generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Добавьте эту строку для миграций
}

enum CurrencyType {
  CRYPTO
  FIAT
}

enum OrderStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
  EXPIRED
  CANCELLED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  OPERATOR
}

model Currency {
  id        String       @id @default(uuid()) @db.Uuid
  code      String       @unique @db.VarChar(10)
  name      String       @db.VarChar(100)
  type      CurrencyType
  isActive  Boolean      @default(true) @map("is_active")
  minAmount Decimal      @map("min_amount") @db.Decimal(20, 8)
  maxAmount Decimal      @map("max_amount") @db.Decimal(20, 8)
  decimals  Int          @default(8)
  network   String?      @db.VarChar(50)
  iconUrl   String?      @map("icon_url")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  ordersFrom Order[]        @relation("OrderFrom")
  ordersTo   Order[]        @relation("OrderTo")
  ratesFrom  ExchangeRate[] @relation("RateFrom")
  ratesTo    ExchangeRate[] @relation("RateTo")

  @@map("currencies")
}

model ExchangeRate {
  id             String   @id @default(uuid()) @db.Uuid
  fromCurrencyId String   @map("from_currency_id") @db.Uuid
  toCurrencyId   String   @map("to_currency_id") @db.Uuid
  rate           Decimal  @db.Decimal(20, 8)
  spreadPercent  Decimal  @default(0.5) @map("spread_percent") @db.Decimal(5, 2)
  effectiveRate  Decimal  @map("effective_rate") @db.Decimal(20, 8)
  source         String   @default("binance") @db.VarChar(50)
  fetchedAt      DateTime @map("fetched_at")
  createdAt      DateTime @default(now()) @map("created_at")

  fromCurrency Currency @relation("RateFrom", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("RateTo", fields: [toCurrencyId], references: [id])
  orders       Order[]

  @@unique([fromCurrencyId, toCurrencyId])
  @@map("exchange_rates")
}

model Order {
  id             String      @id @default(uuid()) @db.Uuid
  code           String      @unique @db.VarChar(20)
  userId         String?     @map("user_id") @db.Uuid
  fromCurrencyId String      @map("from_currency_id") @db.Uuid
  toCurrencyId   String      @map("to_currency_id") @db.Uuid
  fromAmount     Decimal     @map("from_amount") @db.Decimal(20, 8)
  toAmount       Decimal     @map("to_amount") @db.Decimal(20, 8)
  exchangeRateId String      @map("exchange_rate_id") @db.Uuid
  lockedRate     Decimal     @map("locked_rate") @db.Decimal(20, 8)
  status         OrderStatus @default(PENDING)
  clientEmail    String      @map("client_email") @db.VarChar(255)
  clientPhone    String?     @map("client_phone") @db.VarChar(50)
  clientWallet   String      @map("client_wallet") @db.VarChar(255)
  adminNotes     String?     @map("admin_notes") @db.Text
  processedBy    String?     @map("processed_by") @db.Uuid
  expiresAt      DateTime    @map("expires_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  user             User?                @relation("UserOrders", fields: [userId], references: [id])
  fromCurrency     Currency             @relation("OrderFrom", fields: [fromCurrencyId], references: [id])
  toCurrency       Currency             @relation("OrderTo", fields: [toCurrencyId], references: [id])
  exchangeRate     ExchangeRate         @relation(fields: [exchangeRateId], references: [id])
  processedByAdmin Admin?               @relation(fields: [processedBy], references: [id])
  statusHistory    OrderStatusHistory[]

  @@index([status, createdAt])
  @@index([clientEmail])
  @@index([expiresAt])
  @@index([userId])
  @@map("orders")
}

model OrderStatusHistory {
  id         String   @id @default(uuid()) @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  fromStatus String   @map("from_status") @db.VarChar(50)
  toStatus   String   @map("to_status") @db.VarChar(50)
  changedBy  String?  @map("changed_by") @db.Uuid
  reason     String?  @db.Text
  ipAddress  String?  @map("ip_address") @db.Inet
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("order_status_history")
}

model Admin {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique @db.VarChar(255)
  passwordHash   String    @map("password_hash")
  role           AdminRole @default(OPERATOR)
  totpSecret     String?   @map("totp_secret")
  is2faEnabled   Boolean   @default(false) @map("is_2fa_enabled")
  isActive       Boolean   @default(true) @map("is_active")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  sessions         AdminSession[]
  auditLogs        AuditLog[]
  orders           Order[]
  moderatedReviews Review[]
  createdPromos    Promo[]        @relation("PromoCreator")

  @@map("admins")
}

model AdminSession {
  id          String   @id @default(uuid()) @db.Uuid
  adminId     String   @map("admin_id") @db.Uuid
  tokenHash   String   @map("token_hash")
  ipAddress   String   @map("ip_address") @db.Inet
  userAgent   String   @map("user_agent") @db.Text
  fingerprint String?
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  adminId    String?  @map("admin_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Uuid
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent") @db.Text
  requestId  String?  @map("request_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  admin Admin? @relation(fields: [adminId], references: [id])

  @@index([entityType, entityId])
  @@index([adminId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       Json
  description String?  @db.Text
  updatedBy   String?  @map("updated_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ==================== USER AUTH ====================

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

model User {
  id             String     @id @default(uuid()) @db.Uuid
  email          String     @unique @db.VarChar(255)
  passwordHash   String     @map("password_hash")
  firstName      String?    @map("first_name") @db.VarChar(100)
  lastName       String?    @map("last_name") @db.VarChar(100)
  phone          String?    @db.VarChar(50)
  avatarUrl      String?    @map("avatar_url")
  status         UserStatus @default(ACTIVE)
  isVerified     Boolean    @default(false) @map("is_verified")
  verifyToken    String?    @map("verify_token")
  resetToken     String?    @map("reset_token")
  resetTokenExp  DateTime?  @map("reset_token_exp")
  telegramId     String?    @map("telegram_id") @db.VarChar(100)
  whatsappPhone  String?    @map("whatsapp_phone") @db.VarChar(50)
  preferredLang  String     @default("en") @map("preferred_lang") @db.VarChar(5)
  lastLoginAt    DateTime?  @map("last_login_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  sessions  UserSession[]
  reviews   Review[]
  orders    Order[]       @relation("UserOrders")

  @@index([email])
  @@index([telegramId])
  @@map("users")
}

model UserSession {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  tokenHash   String   @map("token_hash")
  ipAddress   String   @map("ip_address") @db.Inet
  userAgent   String   @map("user_agent") @db.Text
  deviceInfo  String?  @map("device_info")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("user_sessions")
}

// ==================== REVIEWS ====================

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

model Review {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String?      @map("user_id") @db.Uuid
  orderId     String?      @map("order_id") @db.Uuid
  authorName  String       @map("author_name") @db.VarChar(100)
  authorEmail String?      @map("author_email") @db.VarChar(255)
  rating      Int          @db.SmallInt
  title       String?      @db.VarChar(200)
  content     String       @db.Text
  status      ReviewStatus @default(PENDING)
  moderatedBy String?      @map("moderated_by") @db.Uuid
  moderatedAt DateTime?    @map("moderated_at")
  adminNotes  String?      @map("admin_notes") @db.Text
  ipAddress   String?      @map("ip_address") @db.Inet
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user      User?  @relation(fields: [userId], references: [id])
  moderator Admin? @relation(fields: [moderatedBy], references: [id])

  @@index([status, createdAt])
  @@index([rating])
  @@map("reviews")
}

// ==================== PROMO ====================

enum PromoType {
  DISCOUNT_PERCENT
  DISCOUNT_FIXED
  BONUS
}

model Promo {
  id            String    @id @default(uuid()) @db.Uuid
  code          String    @unique @db.VarChar(50)
  type          PromoType
  value         Decimal   @db.Decimal(10, 2)
  description   String?   @db.Text
  minAmount     Decimal?  @map("min_amount") @db.Decimal(20, 8)
  maxUses       Int?      @map("max_uses")
  usedCount     Int       @default(0) @map("used_count")
  validFrom     DateTime  @map("valid_from")
  validUntil    DateTime  @map("valid_until")
  isActive      Boolean   @default(true) @map("is_active")
  createdBy     String?   @map("created_by") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  creator Admin? @relation("PromoCreator", fields: [createdBy], references: [id])
  usages  PromoUsage[]

  @@index([code])
  @@index([validFrom, validUntil])
  @@map("promos")
}

model PromoUsage {
  id        String   @id @default(uuid()) @db.Uuid
  promoId   String   @map("promo_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  orderId   String?  @map("order_id") @db.Uuid
  discount  Decimal  @db.Decimal(20, 8)
  usedAt    DateTime @default(now()) @map("used_at")

  promo Promo @relation(fields: [promoId], references: [id])

  @@index([promoId])
  @@map("promo_usages")
}

// ==================== NOTIFICATIONS ====================

enum NotificationChannel {
  EMAIL
  TELEGRAM
  WHATSAPP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model NotificationTemplate {
  id        String              @id @default(uuid()) @db.Uuid
  name      String              @unique @db.VarChar(100)
  channel   NotificationChannel
  subject   String?             @db.VarChar(255)
  template  String              @db.Text
  variables Json?
  isActive  Boolean             @default(true) @map("is_active")
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  @@map("notification_templates")
}

model NotificationLog {
  id          String              @id @default(uuid()) @db.Uuid
  userId      String?             @map("user_id") @db.Uuid
  channel     NotificationChannel
  recipient   String              @db.VarChar(255)
  subject     String?             @db.VarChar(255)
  content     String              @db.Text
  status      NotificationStatus  @default(PENDING)
  errorMsg    String?             @map("error_msg") @db.Text
  sentAt      DateTime?           @map("sent_at")
  readAt      DateTime?           @map("read_at")
  metadata    Json?
  createdAt   DateTime            @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([channel, status])
  @@map("notification_logs")
}

// ==================== LOCATIONS ====================

model Country {
  id         String   @id @default(uuid()) @db.Uuid
  code       String   @unique @db.VarChar(3)
  nameEn     String   @map("name_en") @db.VarChar(100)
  nameRu     String?  @map("name_ru") @db.VarChar(100)
  nameUa     String?  @map("name_ua") @db.VarChar(100)
  nameDe     String?  @map("name_de") @db.VarChar(100)
  flagEmoji  String?  @map("flag_emoji") @db.VarChar(10)
  phoneCode  String?  @map("phone_code") @db.VarChar(10)
  currency   String?  @db.VarChar(10)
  timezone   String?  @db.VarChar(50)
  sortOrder  Int      @default(0) @map("sort_order")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  cities         City[]
  paymentMethods PaymentMethod[]

  @@index([isActive, sortOrder])
  @@map("countries")
}

model City {
  id          String   @id @default(uuid()) @db.Uuid
  countryId   String   @map("country_id") @db.Uuid
  nameEn      String   @map("name_en") @db.VarChar(100)
  nameRu      String?  @map("name_ru") @db.VarChar(100)
  nameUa      String?  @map("name_ua") @db.VarChar(100)
  nameDe      String?  @map("name_de") @db.VarChar(100)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  population  Int?
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  isFeatured  Boolean  @default(false) @map("is_featured")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  country        Country         @relation(fields: [countryId], references: [id])
  paymentMethods PaymentMethod[]
  transfers      MoneyTransfer[]

  @@index([countryId, isActive])
  @@index([isFeatured])
  @@map("cities")
}

// ==================== PAYMENT METHODS ====================

enum PaymentMethodType {
  CASH
  CARD
  BANK_TRANSFER
  CRYPTO_WALLET
  MOBILE_PAYMENT
}

model PaymentMethod {
  id             String            @id @default(uuid()) @db.Uuid
  type           PaymentMethodType
  nameEn         String            @map("name_en") @db.VarChar(100)
  nameRu         String?           @map("name_ru") @db.VarChar(100)
  nameUa         String?           @map("name_ua") @db.VarChar(100)
  nameDe         String?           @map("name_de") @db.VarChar(100)
  descriptionEn  String?           @map("description_en") @db.Text
  descriptionRu  String?           @map("description_ru") @db.Text
  icon           String?           @db.VarChar(100)
  countryId      String?           @map("country_id") @db.Uuid
  cityId         String?           @map("city_id") @db.Uuid
  minAmount      Decimal?          @map("min_amount") @db.Decimal(20, 2)
  maxAmount      Decimal?          @map("max_amount") @db.Decimal(20, 2)
  feePercent     Decimal           @default(0) @map("fee_percent") @db.Decimal(5, 2)
  feeFixed       Decimal           @default(0) @map("fee_fixed") @db.Decimal(20, 2)
  processingTime String?           @map("processing_time") @db.VarChar(100)
  instructions   String?           @db.Text
  sortOrder      Int               @default(0) @map("sort_order")
  isActive       Boolean           @default(true) @map("is_active")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  country   Country? @relation(fields: [countryId], references: [id])
  city      City?    @relation(fields: [cityId], references: [id])

  @@index([type, isActive])
  @@index([countryId])
  @@index([cityId])
  @@map("payment_methods")
}

// ==================== MONEY TRANSFERS ====================

enum TransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

model MoneyTransfer {
  id              String         @id @default(uuid()) @db.Uuid
  code            String         @unique @db.VarChar(20)
  userId          String?        @map("user_id") @db.Uuid
  senderName      String         @map("sender_name") @db.VarChar(200)
  senderPhone     String         @map("sender_phone") @db.VarChar(50)
  senderEmail     String?        @map("sender_email") @db.VarChar(255)
  recipientName   String         @map("recipient_name") @db.VarChar(200)
  recipientPhone  String         @map("recipient_phone") @db.VarChar(50)
  recipientCityId String         @map("recipient_city_id") @db.Uuid
  amount          Decimal        @db.Decimal(20, 2)
  currency        String         @db.VarChar(10)
  fee             Decimal        @db.Decimal(20, 2)
  totalAmount     Decimal        @map("total_amount") @db.Decimal(20, 2)
  status          TransferStatus @default(PENDING)
  notes           String?        @db.Text
  adminNotes      String?        @map("admin_notes") @db.Text
  processedBy     String?        @map("processed_by") @db.Uuid
  completedAt     DateTime?      @map("completed_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  recipientCity City @relation(fields: [recipientCityId], references: [id])

  @@index([status, createdAt])
  @@index([senderPhone])
  @@index([recipientPhone])
  @@map("money_transfers")
}

// ==================== EXCHANGE PAIRS (for admin) ====================

model ExchangePair {
  id            String   @id @default(uuid()) @db.Uuid
  fromCurrency  String   @map("from_currency") @db.VarChar(10)
  toCurrency    String   @map("to_currency") @db.VarChar(10)
  spreadBuy     Decimal  @map("spread_buy") @db.Decimal(5, 2)
  spreadSell    Decimal  @map("spread_sell") @db.Decimal(5, 2)
  minAmount     Decimal  @map("min_amount") @db.Decimal(20, 8)
  maxAmount     Decimal  @map("max_amount") @db.Decimal(20, 8)
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([fromCurrency, toCurrency])
  @@index([isActive])
  @@map("exchange_pairs")
}
